#!/bin/bash
SA_FLAGS="-mac_addr 0:0:0:0:0:0"
SA_FLAGS="$SA_FLAGS -use_local_stats_fetcher=false"
SA_FLAGS="$SA_FLAGS -nms_publisher_send_status=false"
SA_FLAGS="$SA_FLAGS -pub_cs_entities /etc/stats_config/controller_cs_pub_entities.json"

if [ ! -f $AGENT_ROOTFS/etc/resolv.conf ]; then
  echo "Create resolv.conf"
  echo "nameserver 8.8.8.8" > $AGENT_ROOTFS/etc/resolv.conf
fi

if [ -z "$AGGR_IP" ]; then
  SA_FLAGS="$SA_FLAGS -aggregator_ip ::1"
else
  SA_FLAGS="$SA_FLAGS -aggregator_ip $AGGR_IP"
fi

if [ -n "$AGENT_ROOTFS" ] && [ -d "$AGENT_ROOTFS" ]; then
  chroot $AGENT_ROOTFS /bin/mknod /dev/urandom c 1 9 2>/dev/null
  chroot $AGENT_ROOTFS /usr/sbin/stats_agent -v 2 $SA_FLAGS -logtostderr
else
  echo "AGENT_ROOTFS not set, please configure in /etc/sysconfig/tg_services"
fi
