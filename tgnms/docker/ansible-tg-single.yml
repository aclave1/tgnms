- hosts: nms
  become_user: root
  become: yes
  roles:
    - role: zaxos.docker-ce-ansible-role
  tasks:
    - name: Adding existing ubuntu user to docker group
      user: 
        name: ubuntu
        groups: docker
        append: yes
    
    - name: Install python3-pip
      apt:
        name: python3-pip
        state: present
    
    - name: pip3 install docker
      pip:
        name: docker
        state: present
    
    - name: pip3 install docker-compose
      pip:
        name: docker-compose
        state: present

    - name: mkdir terragraph
      file:
        path: terragraph
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0755

    - name: mkdir docker_volumes
      file:
        path: terragraph/docker_volumes
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0755

    - name: mkdir mysql
      file:
        path: terragraph/docker_volumes/mysql_db
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0755

    - name: mkdir beringei
      file:
        path: terragraph/docker_volumes/beringei
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0755

    - name: mkdir cxl
      file:
        path: terragraph/docker_volumes/cxl
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0775
    
    - name: copy cxl.sql
      template:
        src: cxl.sql
        dest: terragraph/docker_volumes/cxl/cxl.sql
        owner: ubuntu
        group: ubuntu
        mode: 0644
    
    - name: copy compose
      template:
        src: docker-compose-single.yml
        dest: terragraph/docker-compose.yml
        owner: ubuntu
        group: ubuntu
        mode: 0644
    
    - name: log into registry
      docker_login:
        username: tgdeploy
        password: 4l5C46xVJ0h74OmRWPK5
        registry_url: https://secure.cxl-terragraph.com:443/v2
        reauthorize: yes
    
    - name: run compose
      docker_service:
        project_src: terragraph/.
        build: no
        state: present
        pull: yes
        stopped: no
        debug: yes
