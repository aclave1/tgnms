- hosts: nms
  become_user: root
  become: yes
  vars:
    docker_user: "ubuntu"
    pip_package: "python3-pip"
  pre_tasks:
    - name: version check
      assert:
        that: "ansible_version.full is version_compare('2.5', '>=')"
        msg: "You must have ansible version 2.5 or later"
    - name: announcement
      debug:
        msg: "Ansible go"
  roles:
    - role: zaxos.docker-ce-ansible-role
  tasks:
    - name: set advertisement handling int
      sysctl:
        name: net.ipv6.conf.{{ ansible_default_ipv6.interface }}.accept_ra
        value: 2
        sysctl_set: yes
        reload: yes

    - name: set advertisement handling all
      sysctl:
        name: net.ipv6.conf.all.accept_ra
        value: 2
        sysctl_set: yes
        reload: yes

    - name: set all forwarding
      sysctl:
        name: net.ipv6.conf.all.forwarding
        value: 1
        sysctl_set: yes
        reload: yes

    - name: set default forwarding
      sysctl:
        name: net.ipv6.conf.default.forwarding
        value: 1
        sysctl_set: yes
        reload: yes

    - name: flush ip6tables filter
      iptables:
        table: filter
        ip_version: ipv6
        flush: true

    - name: flush ip6tables nat
      iptables:
        table: nat
        ip_version: ipv6
        flush: true

    - name: Adding existing user to docker group
      user: 
        name: "{{ docker_user }}"
        groups: docker
        append: yes
    
    - name: Install pip (Ubuntu)
      apt:
        name: "{{ pip_package }}"
        state: present
      when: ansible_distribution == 'Ubuntu'

    - name: Add EPEL repo (Centos)
      yum_repository:
        name: epel
        description: EPEL YUM repo
        baseurl: https://download.fedoraproject.org/pub/epel/$releasever/$basearch/
        gpgcheck: no
      when: ansible_distribution == "CentOS"
    
    - name: Install pip (Centos)
      yum:
        name: "{{ pip_package }}"
        state: present
      when: ansible_distribution == "CentOS"
    
    - name: pip install docker
      pip:
        name: docker
        state: present
    
    - name: pip install docker-compose
      pip:
        name: docker-compose
        state: present

    - name: mkdir terragraph
      file:
        path: terragraph
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: mkdir docker_volumes
      file:
        path: terragraph/docker_volumes
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: mkdir beringei
      file:
        path: terragraph/docker_volumes/beringei
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: mkdir logs
      file:
        path: terragraph/docker_volumes/logs
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: mkdir mysql_db
      file:
        path: terragraph/docker_volumes/mysql_db
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: mkdir mysql_init_scripts
      file:
        path: terragraph/mysql_init_scripts
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: copy mysql init script
      template:
        src: mysql_init_scripts/cxl.sql
        dest: terragraph/mysql_init_scripts/cxl.sql
        owner: "{{ docker_user }}"
        group: docker
        mode: 0644

    - name: mkdir nms_config
      file:
        path: terragraph/docker_volumes/nms_config
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: add cleaner
      template:
        src: destructively-clean-all-docker.sh
        dest: terragraph/destructively-clean-all-docker.sh
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: copy compose
      template:
        src: docker-compose-single.yml
        dest: terragraph/docker-compose.yml
        owner: "{{ docker_user }}"
        group: docker
        mode: 0644

    - name: mkdir environment configs
      file:
        path: terragraph/env
        state: directory
        owner: "{{ docker_user }}"
        group: docker
        mode: 0755

    - name: copy environment configs
      template:
        src: "{{ item }}"
        dest: terragraph/env/
        force: no
        owner: "{{ docker_user }}"
        group: docker
        mode: 0644
      with_fileglob:
        - env/*
    
    - name: log into registry
      docker_login:
        username: tgdeploy
        password: 4l5C46xVJ0h74OmRWPK5
        registry_url: https://secure.cxl-terragraph.com:443/v2
        reauthorize: yes

    - name: rm -f docker network
      command: docker network prune -f

    - name: docker network
      command: docker network create --ipv6 --subnet=fd00:420:69::/48 terragraph_net

    - name: run compose
      docker_service:
        project_src: terragraph/.
        build: no
        state: present
        pull: yes
        stopped: no
        debug: yes
